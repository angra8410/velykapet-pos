<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Escáner QuaggaJS — Velykapet POS</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
  <style>
    /* ... estilos igual que antes ... */
    body { font-family: Arial, Helvetica, sans-serif;margin:0;padding:0;background:#fff;}
    .main-wrap { max-width: 720px; margin: 24px auto 0 auto; padding: 0 12px; display: block; }
    h2 { text-align:center;margin-bottom:32px;font-size:2rem;font-weight:600;}
    #video-box { width:100%; background:#000; border:1px solid #ddd; margin-bottom:24px; display:block; position:relative; height:360px; overflow:hidden; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.04);}
    #video { width:100%; height:100%; display:block; background:#000; object-fit:cover; position:relative; z-index:1; border-radius:10px;}
    #controls { display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:center; margin:0 0 24px 0; position:relative; z-index:2; background:none;}
    button { padding:8px 20px; font-size:15px; border:1px solid #bbb; border-radius:4px; background:#f7f7f7; cursor:pointer; transition:background 0.18s, border 0.18s;}
    button:disabled { background:#eaeaea; color:#888; cursor:not-allowed; border-color:#eee;}
    label { font-size:14px; color:#333; font-weight:500; margin-right:8px; display:flex; align-items:center;}
    select, input[type="number"] { font-size:15px; padding:4px 8px; border-radius:4px; border:1px solid #ccc; margin-left:6px;}
    #action-buttons { display:none; text-align:center; margin-top:18px; margin-bottom:12px; gap:16px;}
    #action-buttons button { padding:10px 24px; font-size:15px; font-weight:600; border-radius:6px; border:1.5px solid #666; background:#e7e7e7; margin:0 8px;}
    #status, #last, #log, footer { display:block; margin-bottom:10px; max-width:720px; margin-left:auto; margin-right:auto;}
    #status { margin-top:12px; color:#222; word-break:break-word; font-size:16px;}
    #last { font-weight:600; font-size:15px;}
    #codes-list { padding:8px; background:#f5f5f5; border-radius:6px; margin-bottom:14px; font-size:14px; max-height:90px; overflow-y:auto; font-family:monospace;}
    #log { padding:8px; border:1px solid #eee; background:#fafafa; max-height:220px; overflow:auto; font-family:monospace; font-size:13px; white-space:pre-wrap; border-radius:6px;}
    footer { color:#666; font-size:13px; text-align:center; margin-top:15px; margin-bottom:24px;}
    @media (max-width:800px) { .main-wrap, #status, #last, #log, footer { max-width:95vw;} #video-box { height:200px;} }
    @media (max-width:500px) { #controls, #action-buttons { flex-direction:column; gap:8px;} #video-box { height:140px;} h2 { font-size:1.15rem;} }
  </style>
</head>
<body>
  <div class="main-wrap">
    <h2>Escáner con cámara (QuaggaJS v1)</h2>
    <div id="video-box"><div id="video"></div></div>
    <div id="controls">
      <button id="startBtn">Iniciar cámara</button>
      <button id="stopBtn" disabled>Detener</button>
      <label>Tipo:
        <select id="tipo">
          <option value="entrada">entrada (sumar)</option>
          <option value="venta" selected>venta (restar)</option>
          <option value="ajuste">ajuste</option>
        </select>
      </label>
      <label>Cantidad:
        <input id="cantidad" type="number" value="1" min="1" style="width:70px" />
      </label>
      <button id="beepBtn">Pitido ON</button>
    </div>
    <div id="action-buttons">
      <button id="nextCodeBtn">Leer otro código</button>
      <button id="finishBtn">Finalizar lectura</button>
    </div>
    <div id="codes-list"></div>
    <div id="status">Estado: detenido</div>
    <div id="last">Último barcode: <span id="lastCode">—</span></div>
    <div id="log"></div>
    <footer>
      Nota: Si hay error, se mostrará en el log.
    </footer>
  </div>
  <script>
    const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbwKqes9-L4GGqu0CnuOLsu5hlt0AsR4UBhvBfm-hTxAXqkK7LRuqDoryB2HKK9rfouD/exec';
    const TOKEN = '';
    const logEl = document.getElementById('log');
    function log(msg) {
      if (logEl) {
        logEl.innerText += new Date().toLocaleTimeString() + ' | ' + String(msg) + '\n';
        logEl.scrollTop = logEl.scrollHeight;
      }
      console.log(msg);
    }
    function setStatus(s) { document.getElementById('status').textContent = 'Estado: ' + s; }
    function setLast(code) { document.getElementById('lastCode').textContent = code; }
    function renderCodesList() {
      const el = document.getElementById('codes-list');
      if (!scannedCodes.length) {
        el.innerHTML = '';
        return;
      }
      el.innerHTML = '<strong>Códigos leídos:</strong><br>' + scannedCodes.map((c, i) => (i+1)+'. '+c).join('<br>');
    }
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const tipoEl = document.getElementById('tipo');
    const cantidadEl = document.getElementById('cantidad');
    const beepBtn = document.getElementById('beepBtn');
    const nextCodeBtn = document.getElementById('nextCodeBtn');
    const finishBtn = document.getElementById('finishBtn');
    const actionButtonsEl = document.getElementById('action-buttons');
    let beepOn = true;
    let sending = false;
    let lastScanned = null;
    let lastTime = 0;
    let waitingForUser = false;
    let scannedCodes = [];
    let lastCodeToSend = null;
    const DUPLICATE_DELAY = 1000;
    let quaggaStarted = false;

    function playBeep() {
      if (!beepOn) return;
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = 'sine';
        o.frequency.value = 1000;
        o.connect(g);
        g.connect(ctx.destination);
        o.start(0);
        g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.12);
        setTimeout(() => { o.stop(); ctx.close(); }, 150);
      } catch (e) { log('Audio error: ' + e); }
    }

    async function postMovementForm(payload, attempts = 2) {
      const url = WEBAPP_URL;
      const params = new URLSearchParams();
      for (const k in payload) {
        if (Object.prototype.hasOwnProperty.call(payload, k) && payload[k] !== undefined) {
          params.append(k, String(payload[k]));
        }
      }
      let lastErr = null;
      for (let i = 1; i <= attempts; i++) {
        try {
          log('POST intento ' + i + ' a ' + url);
          const res = await fetch(url, {
            method: 'POST',
            body: params,
            cache: 'no-store'
          });
          const text = await res.text();
          try { return JSON.parse(text); } catch (e) { return text; }
        } catch (err) {
          lastErr = err;
          log('POST error intento ' + i + ': ' + (err && err.toString ? err.toString() : err));
          await new Promise(r => setTimeout(r, 200 * i));
        }
      }
      throw lastErr;
    }

    async function sendCodeToBackend(code) {
      const cantidad = Number(cantidadEl.value) || 1;
      const tipo = tipoEl.value || 'entrada';
      const payload = { barcode: String(code), cantidad: cantidad, tipo: tipo, usuario: 'camera', token: TOKEN };
      sending = true;
      setStatus('Enviando ' + code + ' ...');
      log('Enviando payload (form): ' + JSON.stringify(payload));
      try {
        const result = await postMovementForm(payload, 2);
        log('Respuesta del servidor: ' + JSON.stringify(result));
        setStatus((result && result.ok) ? 'Respuesta: OK' : 'Respuesta: ERROR');
      } catch (err) {
        log('Todos los intentos fallaron: ' + err);
        setStatus('Error enviando: ' + err);
      } finally {
        sending = false;
      }
    }

    function handleDetectedCode(code) {
      if (waitingForUser) {
        log('Esperando acción del usuario, ignorando código: ' + code);
        return;
      }
      const now = Date.now();
      if (code === lastScanned && (now - lastTime) < DUPLICATE_DELAY) {
        log('duplicado ignorado: ' + code);
        return;
      }
      lastScanned = code; lastTime = now;
      setLast(code);
      playBeep();
      scannedCodes.push(code);
      lastCodeToSend = code;
      renderCodesList();
      setStatus('Código leído: ' + code + '. Confirma si quieres continuar.');
      waitingForUser = true;
      actionButtonsEl.style.display = 'flex';
    }

    startBtn.onclick = () => {
      Quagga.init({
        inputStream: {
          name: "Live",
          type: "LiveStream",
          target: document.querySelector('#video'),
          constraints: {
            facingMode: "environment",
            width: { ideal: 1280 },
            height: { ideal: 720 }
          }
        },
        decoder: {
          readers: [
            "ean_reader"
          ]
        },
        locate: true,
        numOfWorkers: navigator.hardwareConcurrency ? Math.max(2, navigator.hardwareConcurrency - 1) : 2
      }, function (err) {
        if (err) { log('QuaggaJS init error: ' + JSON.stringify(err)); setStatus('Error QuaggaJS: ' + JSON.stringify(err)); return; }
        Quagga.start();
        quaggaStarted = true;
        waitingForUser = false;
        scannedCodes = [];
        lastCodeToSend = null;
        renderCodesList();
        setLast('—');
        setStatus('Cámara activa (QuaggaJS). Apunta al código.');
        startBtn.disabled = true;
        stopBtn.disabled = false;
        actionButtonsEl.style.display = 'none';
        log('QuaggaJS iniciado');
      });
      Quagga.onDetected(function (result) {
        if (!result || !result.codeResult || !result.codeResult.code) return;
        const code = result.codeResult.code;
        // Solo acepta EAN-13
        if (result.codeResult.format !== "ean_13" || code.length !== 13) {
          log('Código ignorado (no EAN-13): ' + code + ' (' + result.codeResult.format + ')');
          return;
        }
        handleDetectedCode(code);
      });
    };

    stopBtn.onclick = () => {
      if (quaggaStarted) {
        Quagga.stop();
        quaggaStarted = false;
        setStatus('Detenido');
        startBtn.disabled = false;
        stopBtn.disabled = true;
        actionButtonsEl.style.display = 'none';
        log('QuaggaJS detenido');
        document.getElementById('video').innerHTML = '';
      }
    };

    beepBtn.onclick = () => {
      beepOn = !beepOn;
      beepBtn.textContent = beepOn ? 'Pitido ON' : 'Pitido OFF';
    };

    nextCodeBtn.onclick = async () => {
      // Solo enviar el último código leído al backend cuando el usuario pulse "Leer otro código"
      if (lastCodeToSend) {
        await sendCodeToBackend(lastCodeToSend);
        lastCodeToSend = null;
      }
      waitingForUser = false;
      setStatus('Listo para leer el siguiente código');
      actionButtonsEl.style.display = 'none';
    };

    finishBtn.onclick = () => {
      if (quaggaStarted) {
        Quagga.stop();
        quaggaStarted = false;
        setStatus('Lectura finalizada. Total códigos: ' + scannedCodes.length);
        startBtn.disabled = false;
        stopBtn.disabled = true;
        actionButtonsEl.style.display = 'none';
        log('Lectura finalizada. Códigos escaneados: ' + JSON.stringify(scannedCodes));
        document.getElementById('video').innerHTML = '';
      }
    };

    log('✅ Listo');
  </script>
</body>
</html>
