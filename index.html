<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Escáner QuaggaJS — Velykapet POS</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
  <style>
    body { font-family: Arial, Helvetica, sans-serif; margin:0; padding:0; background:#fff;}
    .main-wrap { max-width:720px; margin:24px auto 0 auto; padding:0 12px; }
    h2 { text-align:center; margin-bottom:32px; font-size:2rem; font-weight:600; }
    #video-box { width:100%; background:#000; border:1px solid #ddd; margin-bottom:24px; height:360px; overflow:hidden; border-radius:10px;}
    #video { width:100%; height:100%; display:block; background:#000; object-fit:cover; border-radius:10px;}
    #controls { display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:center; margin:0 0 24px 0;}
    button { padding:8px 20px; font-size:15px; border:1px solid #bbb; border-radius:4px; background:#f7f7f7; cursor:pointer;}
    button:disabled { background:#eaeaea; color:#888; cursor:not-allowed; border-color:#eee;}
    label { font-size:14px; color:#333; font-weight:500; margin-right:8px; display:flex; align-items:center;}
    select, input[type="number"] { font-size:15px; padding:4px 8px; border-radius:4px; border:1px solid #ccc; margin-left:6px;}
    #action-buttons { display:none; flex-direction:row; justify-content:center; gap:24px; margin-bottom:16px; }
    #action-buttons button { padding:10px 24px; font-size:15px; font-weight:600; border-radius:6px; border:1.5px solid #666; background:#e7e7e7;}
    #status, #last, #log, footer { margin-bottom:10px; max-width:720px; margin-left:auto; margin-right:auto;}
    #status { margin-top:12px; color:#222; font-size:16px;}
    #last { font-weight:600; font-size:15px;}
    #codes-list { padding:8px; background:#f5f5f5; border-radius:6px; margin-bottom:14px; font-size:14px; max-height:90px; overflow-y:auto; font-family:monospace;}
    #log { padding:8px; border:1px solid #eee; background:#fafafa; max-height:220px; overflow:auto; font-family:monospace; font-size:13px; white-space:pre-wrap; border-radius:6px;}
    #select-code { font-size:16px; padding:6px 12px; margin-right:12px; }
    footer { color:#666; font-size:13px; text-align:center; margin-top:15px; margin-bottom:24px;}
    @media (max-width:800px) { .main-wrap, #status, #last, #log, footer { max-width:95vw;} #video-box { height:200px;} }
    @media (max-width:500px) { #controls, #action-buttons { flex-direction:column; gap:8px;} #video-box { height:140px;} h2 { font-size:1.15rem;} }
  </style>
</head>
<body>
  <div class="main-wrap">
    <h2>Escáner con cámara (QuaggaJS v1)</h2>
    <div id="video-box"><div id="video"></div></div>
    <div id="controls">
      <button id="startBtn">Iniciar cámara</button>
      <button id="stopBtn" disabled>Detener</button>
      <label>Tipo:
        <select id="tipo">
          <option value="entrada">entrada (sumar)</option>
          <option value="venta" selected>venta (restar)</option>
          <option value="ajuste">ajuste</option>
        </select>
      </label>
      <label>Cantidad:
        <input id="cantidad" type="number" value="1" min="1" style="width:70px" />
      </label>
      <button id="beepBtn">Pitido ON</button>
    </div>
    <!-- Botones de acción aparecen tras leer código -->
    <div id="action-buttons">
      <select id="select-code"></select>
      <button id="nextCodeBtn">Enviar código y leer otro</button>
      <button id="finishBtn">Finalizar lectura</button>
    </div>
    <div id="codes-list"></div>
    <div id="status">Estado: detenido</div>
    <div id="last">Último barcode: <span id="lastCode">—</span></div>
    <div id="log"></div>
    <footer>Nota: Si hay error, se mostrará en el log.</footer>
  </div>
  <script>
    const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycby5ci4WD4kSDDreiptSyQIP4rDncJ-HJnN_8uzOHkbnYpWKGxPJH9_VBhw_cyvte1P9/exec';
    const TOKEN = '';
    const logEl = document.getElementById('log');
    function log(msg) {
      if (logEl) {
        logEl.innerText += new Date().toLocaleTimeString() + ' | ' + String(msg) + '\n';
        logEl.scrollTop = logEl.scrollHeight;
      }
      console.log(msg);
    }
    function setStatus(s) { document.getElementById('status').textContent = 'Estado: ' + s; }
    function setLast(code) { document.getElementById('lastCode').textContent = code; }
    function renderCodesList() {
      const el = document.getElementById('codes-list');
      if (!scannedCodes.length) { el.innerHTML = ''; return; }
      el.innerHTML = '<strong>Códigos leídos:</strong><br>' + scannedCodes.map((c, i) => (i+1)+'. '+c).join('<br>');
    }
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const tipoEl = document.getElementById('tipo');
    const cantidadEl = document.getElementById('cantidad');
    const beepBtn = document.getElementById('beepBtn');
    const nextCodeBtn = document.getElementById('nextCodeBtn');
    const finishBtn = document.getElementById('finishBtn');
    const actionButtonsEl = document.getElementById('action-buttons');
    const selectCodeEl = document.getElementById('select-code');
    let beepOn = true;
    let sending = false;
    let waitingForUser = false;
    let scannedCodes = [];
    let codesDetected = [];
    const DUPLICATE_DELAY = 1000;
    let quaggaStarted = false;

    function playBeep() {
      if (!beepOn) return;
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = 'sine'; o.frequency.value = 1000;
        o.connect(g); g.connect(ctx.destination);
        o.start(0);
        g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.12);
        setTimeout(() => { o.stop(); ctx.close(); }, 150);
      } catch (e) { log('Audio error: ' + e); }
    }

    async function postMovementForm(payload, attempts = 2) {
      const url = WEBAPP_URL;
      const params = new URLSearchParams();
      for (const k in payload) if (Object.prototype.hasOwnProperty.call(payload, k) && payload[k] !== undefined) params.append(k, String(payload[k]));
      let lastErr = null;
      for (let i = 1; i <= attempts; i++) {
        try {
          log('POST intento ' + i + ' a ' + url);
          const res = await fetch(url, { method: 'POST', body: params, cache: 'no-store' });
          const text = await res.text();
          try { return JSON.parse(text); } catch (e) { return text; }
        } catch (err) {
          lastErr = err;
          log('POST error intento ' + i + ': ' + (err && err.toString ? err.toString() : err));
          await new Promise(r => setTimeout(r, 200 * i));
        }
      }
      throw lastErr;
    }

    async function sendCodeToBackend(code) {
      const cantidad = Number(cantidadEl.value) || 1;
      const tipo = tipoEl.value || 'entrada';
      const payload = { barcode: String(code), cantidad: cantidad, tipo: tipo, usuario: 'camera', token: TOKEN };
      sending = true;
      setStatus('Enviando ' + code + ' ...');
      log('Enviando payload (form): ' + JSON.stringify(payload));
      try {
        const result = await postMovementForm(payload, 2);
        log('Respuesta del servidor: ' + JSON.stringify(result));
        setStatus((result && result.ok) ? 'Respuesta: OK' : 'Respuesta: ERROR');
      } catch (err) {
        log('Todos los intentos fallaron: ' + err);
        setStatus('Error enviando: ' + err);
      } finally { sending = false; }
    }

    function updateSelectDetected() {
      // Solo muestra EAN-13 de 13 dígitos, únicos
      const uniqueCodes = [];
      selectCodeEl.innerHTML = '';
      codesDetected.forEach(item => {
        if (
          item.format === 'ean_13' &&
          item.code.length === 13 &&
          !uniqueCodes.find(c => c.code === item.code)
        ) {
          uniqueCodes.push(item);
          const opt = document.createElement('option');
          opt.value = item.code;
          opt.textContent = `${item.code} (${item.format})`;
          selectCodeEl.appendChild(opt);
        }
      });
      // Si no hay ningún código válido, muestra opción vacía
      if (selectCodeEl.options.length === 0) {
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = '-- Ningún código válido detectado --';
        selectCodeEl.appendChild(opt);
      }
    }

    function handleDetectedCode(code, format) {
      if (waitingForUser) {
        codesDetected.push({ code, format });
        updateSelectDetected();
        log('Esperando acción del usuario, acumulando código: ' + code);
        return;
      }
      codesDetected = [{ code, format }];
      updateSelectDetected();
      setLast(code);
      playBeep();
      setStatus('Códigos EAN-13 detectados: selecciona el correcto y confirma.');
      waitingForUser = true;
      actionButtonsEl.style.display = 'flex';
    }

    startBtn.onclick = () => {
      Quagga.init({
        inputStream: {
          name: "Live",
          type: "LiveStream",
          target: document.querySelector('#video'),
          constraints: {
            facingMode: "environment",
            width: { ideal: 640 },
            height: { ideal: 480 }
          }
        },
        decoder: {
          readers: [
          "ean_reader",        // EAN-13
          "ean_8_reader",      // EAN-8
          "upc_reader",        // UPC-A
          "upc_e_reader",      // UPC-E
          "code_128_reader"    // Code128            
          ]
        },
        locate: false,
        numOfWorkers: navigator.hardwareConcurrency ? Math.max(2, navigator.hardwareConcurrency - 1) : 2
      }, function (err) {
        if (err) { log('QuaggaJS init error: ' + JSON.stringify(err)); setStatus('Error QuaggaJS: ' + JSON.stringify(err)); return; }
        Quagga.start();
        quaggaStarted = true;
        waitingForUser = false;
        scannedCodes = [];
        codesDetected = [];
        selectCodeEl.innerHTML = '';
        setLast('—');
        setStatus('Cámara activa (QuaggaJS). Apunta al código.');
        startBtn.disabled = true;
        stopBtn.disabled = false;
        actionButtonsEl.style.display = 'none';
        log('QuaggaJS iniciado');
      });
      Quagga.onDetected(function (result) {
        if (!result || !result.codeResult || !result.codeResult.code) return;
        const code = result.codeResult.code;
        const format = result.codeResult.format;
        // Puedes aceptar todos los formatos aquí, o filtrar por longitud si quieres
        handleDetectedCode(code, format);
      });
    };

    stopBtn.onclick = () => {
      if (quaggaStarted) {
        Quagga.stop();
        quaggaStarted = false;
        setStatus('Detenido');
        startBtn.disabled = false;
        stopBtn.disabled = true;
        actionButtonsEl.style.display = 'none';
        log('QuaggaJS detenido');
        document.getElementById('video').innerHTML = '';
      }
    };

    beepBtn.onclick = () => {
      beepOn = !beepOn;
      beepBtn.textContent = beepOn ? 'Pitido ON' : 'Pitido OFF';
    };

    nextCodeBtn.onclick = async () => {
      const selectedCode = selectCodeEl.value;
      if (selectedCode && selectedCode.length === 13) {
        scannedCodes.push(selectedCode);
        renderCodesList();
        await sendCodeToBackend(selectedCode);
      }
      codesDetected = [];
      selectCodeEl.innerHTML = '';
      waitingForUser = false;
      setStatus('Listo para leer el siguiente código');
      actionButtonsEl.style.display = 'none';
    };

    finishBtn.onclick = () => {
      if (quaggaStarted) {
        Quagga.stop();
        quaggaStarted = false;
        setStatus('Lectura finalizada. Total códigos: ' + scannedCodes.length);
        startBtn.disabled = false;
        stopBtn.disabled = true;
        actionButtonsEl.style.display = 'none';
        log('Lectura finalizada. Códigos escaneados: ' + JSON.stringify(scannedCodes));
        document.getElementById('video').innerHTML = '';
      }
    };

    log('✅ Listo');
  </script>
</body>
</html>
