<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Escáner ZXingJS — Velykapet POS</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <script src="https://unpkg.com/@zxing/library@latest"></script>
  <style>
    body { font-family: Arial, Helvetica, sans-serif; margin:0; padding:0; background:#fff;}
    .main-wrap { max-width:720px; margin:24px auto 0 auto; padding:0 12px; }
    h2 { text-align:center; margin-bottom:32px; font-size:2rem; font-weight:600; }
    #video-box { width:100%; background:#000; border:1px solid #ddd; margin-bottom:24px; height:360px; overflow:hidden; border-radius:10px; position:relative;}
    #video { width:100%; height:100%; display:block; background:#000; object-fit:cover; border-radius:10px;}
    /* Responsive scan-area: 80% width, 45% height, centered */
    #scan-area {
      position: absolute;
      left: 50%; top: 50%;
      transform: translate(-50%, -50%);
      width: 80%;
      height: 45%;
      min-width: 220px;
      min-height: 100px;
      border: 2px dashed #d00;
      pointer-events: none;
      box-sizing: border-box;
      z-index: 5;
      background: rgba(255,0,0,0.03);
    }
    #controls { display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:center; margin:0 0 24px 0;}
    button { padding:8px 20px; font-size:15px; border:1px solid #bbb; border-radius:4px; background:#f7f7f7; cursor:pointer;}
    button:disabled { background:#eaeaea; color:#888; cursor:not-allowed; border-color:#eee;}
    label { font-size:14px; color:#333; font-weight:500; margin-right:8px; display:flex; align-items:center;}
    select, input[type="number"] { font-size:15px; padding:4px 8px; border-radius:4px; border:1px solid #ccc; margin-left:6px;}
    #action-buttons { display:none; flex-direction:row; justify-content:center; gap:24px; margin-bottom:16px; }
    #action-buttons button { padding:10px 24px; font-size:15px; font-weight:600; border-radius:6px; border:1.5px solid #666; background:#e7e7e7;}
    #status, #last, #log, footer { margin-bottom:10px; max-width:720px; margin-left:auto; margin-right:auto;}
    #status { margin-top:12px; color:#222; font-size:16px;}
    #last { font-weight:600; font-size:15px;}
    #codes-list { padding:8px; background:#f5f5f5; border-radius:6px; margin-bottom:14px; font-size:14px; max-height:90px; overflow-y:auto; font-family:monospace;}
    #log { padding:8px; border:1px solid #eee; background:#fafafa; max-height:220px; overflow:auto; font-family:monospace; font-size:13px; white-space:pre-wrap; border-radius:6px;}
    #select-camera { font-size:16px; padding:6px 12px; margin-right:12px; }
    #select-code { font-size:16px; padding:6px 12px; margin-right:12px; }
    footer { color:#666; font-size:13px; text-align:center; margin-top:15px; margin-bottom:24px;}
    @media (max-width:800px) {
      .main-wrap, #status, #last, #log, footer { max-width:95vw;}
      #video-box { height:220px;}
      #scan-area { min-width:110px; min-height:60px;}
    }
    @media (max-width:500px) {
      #controls, #action-buttons { flex-direction:column; gap:8px;}
      #video-box { height:140px;}
      h2 { font-size:1.15rem;}
      #scan-area { min-width:70px; min-height:40px;}
    }
  </style>
</head>
<body>
  <div class="main-wrap">
    <h2>Escáner con cámara (ZXingJS)</h2>
    <div id="video-box">
      <video id="video"></video>
      <div id="scan-area"></div>
    </div>
    <div id="controls">
      <select id="select-camera"></select>
      <button id="startBtn">Iniciar cámara</button>
      <button id="stopBtn" disabled>Detener</button>
      <label>Tipo:
        <select id="tipo">
          <option value="entrada">entrada (sumar)</option>
          <option value="venta" selected>venta (restar)</option>
          <option value="ajuste">ajuste</option>
        </select>
      </label>
      <label>Cantidad:
        <input id="cantidad" type="number" value="1" min="1" style="width:70px" />
      </label>
      <button id="beepBtn">Pitido ON</button>
    </div>
    <div id="action-buttons">
      <select id="select-code"></select>
      <button id="nextCodeBtn">Enviar código y leer otro</button>
      <button id="finishBtn">Finalizar lectura</button>
    </div>
    <div id="codes-list"></div>
    <div id="status">Estado: detenido</div>
    <div id="last">Último barcode: <span id="lastCode">—</span></div>
    <div id="log"></div>
    <footer>Nota: Si hay error, se mostrará en el log.</footer>
  </div>
  <script>
    const WEBAPP_URL = 'https://localhost:5001/api/inventory';
    const TOKEN = '';
    const logEl = document.getElementById('log');
    function log(msg) {
      if (logEl) {
        logEl.innerText += new Date().toLocaleTimeString() + ' | ' + String(msg) + '\n';
        logEl.scrollTop = logEl.scrollHeight;
      }
      console.log(msg);
    }
    function setStatus(s) { document.getElementById('status').textContent = 'Estado: ' + s; }
    function setLast(code) { document.getElementById('lastCode').textContent = code; }
    function renderCodesList() {
      const el = document.getElementById('codes-list');
      if (!scannedCodes.length) { el.innerHTML = ''; return; }
      el.innerHTML = '<strong>Códigos leídos:</strong><br>' + scannedCodes.map((c, i) => (i+1)+'. '+c).join('<br>');
    }
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const tipoEl = document.getElementById('tipo');
    const cantidadEl = document.getElementById('cantidad');
    const beepBtn = document.getElementById('beepBtn');
    const nextCodeBtn = document.getElementById('nextCodeBtn');
    const finishBtn = document.getElementById('finishBtn');
    const actionButtonsEl = document.getElementById('action-buttons');
    const selectCodeEl = document.getElementById('select-code');
    const selectCameraEl = document.getElementById('select-camera');
    let beepOn = true;
    let sending = false;
    let waitingForUser = false;
    let scannedCodes = [];
    let codesDetected = [];

    let codeReader = null;
    let videoInputDevices = [];
    let selectedDeviceId = null;
    let scanning = false;
    let lastConfirmedCode = "";
    let lastDetectedCode = "";

    function playBeep() {
      if (!beepOn) return;
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = 'sine'; o.frequency.value = 1000;
        o.connect(g); g.connect(ctx.destination);
        o.start(0);
        g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.12);
        setTimeout(() => { o.stop(); ctx.close(); }, 150);
      } catch (e) { log('Audio error: ' + e); }
    }

    // --- CAMBIO SOLICITADO: fetch ahora envía JSON ---
    async function postMovementForm(payload, attempts = 2) {
      const url = WEBAPP_URL;
      let lastErr = null;
      for (let i = 1; i <= attempts; i++) {
        try {
          log('POST intento ' + i + ' a ' + url);
          const res = await fetch(url, {
            method: 'POST',
            body: JSON.stringify(payload),
            headers: { "Content-Type": "application/json" }
          });
          const text = await res.text();
          try { return JSON.parse(text); } catch (e) { return text; }
        } catch (err) {
          lastErr = err;
          log('POST error intento ' + i + ': ' + (err && err.toString ? err.toString() : err));
          await new Promise(r => setTimeout(r, 200 * i));
        }
      }
      throw lastErr;
    }
    // --- FIN DEL CAMBIO ---

    async function sendCodeToBackend(code) {
      const cantidad = Number(cantidadEl.value) || 1;
      const tipo = tipoEl.value || 'entrada';
      const payload = { barcode: String(code), cantidad: cantidad, tipo: tipo, usuario: 'camera', token: TOKEN };
      sending = true;
      setStatus('Enviando ' + code + ' ...');
      log('Enviando payload (form): ' + JSON.stringify(payload));
      try {
        const result = await postMovementForm(payload, 2);
        log('Respuesta del servidor: ' + JSON.stringify(result));
        setStatus((result && result.ok) ? 'Respuesta: OK' : 'Respuesta: ERROR');
      } catch (err) {
        log('Todos los intentos fallaron: ' + err);
        setStatus('Error enviando: ' + err);
      } finally { sending = false; }
    }

    function updateSelectDetected() {
      // Mostrar todos los códigos detectados únicos
      const uniqueCodes = [];
      selectCodeEl.innerHTML = '';
      codesDetected.forEach(item => {
        if (
          item.code &&
          !uniqueCodes.find(c => c.code === item.code && c.format === item.format)
        ) {
          uniqueCodes.push(item);
          const opt = document.createElement('option');
          opt.value = item.code;
          opt.textContent = `${item.code} (${item.format})`;
          selectCodeEl.appendChild(opt);
        }
      });
      if (selectCodeEl.options.length === 0) {
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = '-- Ningún código válido detectado --';
        selectCodeEl.appendChild(opt);
      }
    }

    function handleDetectedCode(code, format) {
      if (waitingForUser) {
        if (!codesDetected.find(c => c.code === code && c.format === format)) {
          codesDetected.push({ code, format });
          updateSelectDetected();
          log('Esperando acción del usuario, acumulando código: ' + code + ' (' + format + ')');
        }
        return;
      }
      codesDetected = [{ code, format }];
      updateSelectDetected();
      setLast(`${code} (${format})`);
      playBeep();
      setStatus('Código detectado: selecciona el correcto y confirma.');
      waitingForUser = true;
      actionButtonsEl.style.display = 'flex';
      log(`Detectado: ${code} (${format})`);
    }

    // Inicializa y lista cámaras al cargar
    async function setupCameras() {
      codeReader = new ZXing.BrowserMultiFormatReader();
      try {
        videoInputDevices = await codeReader.listVideoInputDevices();
        selectCameraEl.innerHTML = '';
        videoInputDevices.forEach((device, idx) => {
          const opt = document.createElement('option');
          opt.value = device.deviceId;
          opt.textContent = device.label || `Cámara ${idx+1}`;
          selectCameraEl.appendChild(opt);
        });
        // Selecciona la cámara posterior por defecto si existe
        let backIdx = videoInputDevices.findIndex(dev =>
          dev.label.toLowerCase().includes('back') ||
          dev.label.toLowerCase().includes('trasera') ||
          dev.label.toLowerCase().includes('rear')
        );
        selectCameraEl.selectedIndex = backIdx >= 0 ? backIdx : 0;
      } catch (err) {
        log('Error obteniendo cámaras: ' + err);
        setStatus('Error obteniendo cámaras');
      }
    }

    // Al cambiar de cámara manualmente
    selectCameraEl.onchange = () => {
      if (scanning) {
        stopBtn.click();
        startBtn.click();
      }
    };

    startBtn.onclick = async () => {
      setStatus('Escaneando...');
      selectedDeviceId = selectCameraEl.value;
      startBtn.disabled = true;
      stopBtn.disabled = false;
      actionButtonsEl.style.display = 'none';
      codesDetected = [];
      scannedCodes = [];
      selectCodeEl.innerHTML = '';
      setLast('—');
      waitingForUser = false;
      scanning = true;
      codeReader.decodeFromVideoDevice(selectedDeviceId, 'video', (result, err) => {
        if (result) {
          const code = result.text;
          const format = result.barcodeFormat;
          if (code && code !== lastConfirmedCode && code !== lastDetectedCode) {
            lastDetectedCode = code;
            handleDetectedCode(code, format);
          }
        }
        if (err && !(err instanceof ZXing.NotFoundException)) {
          log('Error de escaneo: ' + err);
        }
      });
      log('ZXingJS iniciado');
    };

    stopBtn.onclick = () => {
      if (codeReader && scanning) {
        codeReader.reset();
        scanning = false;
        setStatus('Detenido');
        startBtn.disabled = false;
        stopBtn.disabled = true;
        actionButtonsEl.style.display = 'none';
        log('ZXingJS detenido');
        document.getElementById('video').srcObject = null;
      }
    };

    beepBtn.onclick = () => {
      beepOn = !beepOn;
      beepBtn.textContent = beepOn ? 'Pitido ON' : 'Pitido OFF';
    };

    nextCodeBtn.onclick = async () => {
      const selectedCode = selectCodeEl.value;
      if (selectedCode) {
        lastConfirmedCode = selectedCode;
        scannedCodes.push(selectedCode);
        renderCodesList();
        await sendCodeToBackend(selectedCode);
      }
      codesDetected = [];
      selectCodeEl.innerHTML = '';
      waitingForUser = false;
      setStatus('Listo para leer el siguiente código');
      actionButtonsEl.style.display = 'none';
    };

    finishBtn.onclick = () => {
      if (codeReader && scanning) {
        codeReader.reset();
        scanning = false;
        setStatus('Lectura finalizada. Total códigos: ' + scannedCodes.length);
        startBtn.disabled = false;
        stopBtn.disabled = true;
        actionButtonsEl.style.display = 'none';
        log('Lectura finalizada. Códigos escaneados: ' + JSON.stringify(scannedCodes));
        document.getElementById('video').srcObject = null;
      }
    };

    // Inicializa cámaras al cargar la página
    window.onload = setupCameras;
    log('✅ Listo');
  </script>
</body>
</html>
