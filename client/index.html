<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Velykapet POS - Scanner</title>
  <style>
    body{font-family:Arial, sans-serif; margin:0; display:flex; flex-direction:column; height:100vh;}
    #video{width:100%; height:60vh; background:#000; object-fit:cover;}
    #controls{padding:10px; display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
    button{padding:10px 14px; font-size:16px;}
    #status{padding:6px; font-size:14px; color:#222;}
  </style>
</head>
<body>
  <video id="video" autoplay muted playsinline></video>
  <div id="controls">
    <label>Cantidad <input id="cantidad" type="number" value="1" min="1" style="width:70px"></label>
    <label>Usuario <input id="usuario" type="text" value="caja1" style="width:120px"></label>
    <button id="toggleCam">Iniciar cámara</button>
    <button id="testSend">Enviar manual</button>
    <span id="status">Listo</span>
  </div>

  <script>
    // CONFIG: pega aquí la URL de tu Web App y TOKEN si lo usas
    const WEBAPP_URL = 'PASTE_YOUR_WEBAPP_URL_HERE'; // ej: https://script.google.com/macros/s/AKfy.../exec
    const TOKEN = ''; // si configuras token en doPost, colócalo aquí (o dejar '' para no usar)

    const video = document.getElementById('video');
    const status = document.getElementById('status');
    const toggleCam = document.getElementById('toggleCam');
    const cantidadEl = document.getElementById('cantidad');
    const usuarioEl = document.getElementById('usuario');

    let stream = null;
    let scanning = false;
    let detector = null;

    async function startCamera() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
        video.srcObject = stream;
        scanning = true;
        status.textContent = 'Cámara activa — apuntá al código';
        initDetector();
      } catch (err) {
        status.textContent = 'Error cámara: ' + err.message;
      }
    }

    function stopCamera() {
      if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
      scanning = false;
      status.textContent = 'Cámara parada';
    }

    toggleCam.addEventListener('click', () => { if (scanning) stopCamera(); else startCamera(); });

    async function initDetector() {
      if ('BarcodeDetector' in window) {
        try {
          const formats = await window.BarcodeDetector.getSupportedFormats();
          detector = new BarcodeDetector({ formats: formats });
          runNativeDetection();
          return;
        } catch (e) {
          console.warn('BarcodeDetector error', e);
        }
      }
      status.textContent = 'BarcodeDetector no disponible: usar lector físico o integrar QuaggaJS';
    }

    function runNativeDetection() {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      async function tick() {
        if (!scanning || video.readyState !== 4) { requestAnimationFrame(tick); return; }
        canvas.width = video.videoWidth; canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        try {
          const barcodes = await detector.detect(canvas);
          if (barcodes && barcodes.length) {
            const code = barcodes[0].rawValue || barcodes[0].raw_data || barcodes[0].raw;
            onDetected(code);
          }
        } catch (e) { /* ignore */ }
        requestAnimationFrame(tick);
      }
      tick();
    }

    let lastSent = 0;
    function onDetected(code) {
      const now = Date.now();
      if (now - lastSent < 1200) return;
      lastSent = now;
      status.textContent = 'Detectado: ' + code;
      sendSale(code, Number(cantidadEl.value || 1), usuarioEl.value || 'caja1');
    }

    async function sendSale(barcode, cantidad, usuario) {
      status.textContent = 'Enviando...';
      const body = { barcode: String(barcode), cantidad: Number(cantidad), tipo: 'venta', usuario: String(usuario), token: TOKEN };
      try {
        const resp = await fetch(WEBAPP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const j = await resp.json();
        if (j && j.ok) status.textContent = 'Enviado OK: ' + barcode;
        else status.textContent = 'Error servidor: ' + (j && j.error ? j.error : resp.statusText);
      } catch (err) {
        status.textContent = 'Error fetch: ' + err.message;
      }
    }

    document.getElementById('testSend').addEventListener('click', () => {
      const code = prompt('Barcode?');
      if (code) sendSale(code, Number(cantidadEl.value || 1), usuarioEl.value || 'caja1');
    });
  </script>
</body>
</html>
